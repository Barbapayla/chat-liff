<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>即時連線聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --line:#06c755 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
    .hero{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;text-align:center}
    .title{font-size:28px;font-weight:800;margin:4px 0 8px}
    .sub{color:#9ca3af;margin:0 0 24px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--line);border:none;color:#fff;font-weight:800;padding:12px 18px;border-radius:12px;cursor:pointer}
    .chat{display:none}
    .chatHeader{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #1f2937;background:#0c1528}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 10px #22c55e}
    .roomTitle{font-weight:800}
    .me{margin-left:auto;color:#9ca3af;font-size:12px}
    .msgs{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#0a1222}
    .msg{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.35;white-space:pre-wrap;word-break:break-word}
    .msg.me{align-self:flex-end;background:#1d4ed8}
    .msg.other{align-self:flex-start;background:#374151}
    .meta{font-size:12px;color:#d1d5db;margin-bottom:4px;opacity:.8}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #1f2937;background:#0c1528}
    .input{flex:1;padding:12px 14px;border:1px solid #334155;border-radius:12px;background:#0a1222;color:#e5e7eb}
    .send{padding:12px 16px;border:none;border-radius:12px;background:#2563eb;color:#fff;font-weight:800}
    .tips{padding:10px 16px;background:#0a1222;color:#9ca3af;border-top:1px solid #1f2937}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 登入畫面 -->
    <div id="landing" class="card hero">
      <div class="title">即將進入即時連線聊天室</div>
      <p class="sub">這是一個多人共用的聊天室。請先以 LINE 登入。</p>
      <button id="loginBtn" class="btn">以 LINE 登入</button>
    </div>

    <!-- 聊天室 -->
    <div id="chat" class="card chat">
      <div class="chatHeader">
        <div class="dot"></div>
        <div class="roomTitle">多人聊天室</div>
        <div id="ctx" class="me"></div>
      </div>
      <div id="msgs" class="msgs"></div>
      <div class="composer">
        <input id="text" class="input" placeholder="輸入訊息，按 Enter 送出" />
        <button id="send" class="send">送出</button>
      </div>
      <div class="tips">訊息存於 <code>public.messages</code>。讀寫走 Edge Functions 以避免 WebView 的 CORS 限制。</div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    /************* 設定 *************/
    const LIFF_ID = "2007964190-lv3NAx5a";
    const SUPABASE_URL = "https://mqnreqlsukmtubvgcfm.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xbnJlcWxzdWttdG51YnZnY2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzYyNzksImV4cCI6MjA3MTI1MjI3OX0.WVnitC3EIzJANy8eEY6LaCGMV8aoNcxwJQGL5_YIZUc";

    // 你的 Edge Functions（已假設 slug 為 db-read / db-write / line-push）
    const READ_URL  = `${SUPABASE_URL}/functions/v1/db-read`;
    const WRITE_URL = `${SUPABASE_URL}/functions/v1/db-write`;
    const PUSH_URL  = `${SUPABASE_URL}/functions/v1/line-push`; // 可選：要推播才會用到

    /************* 狀態 *************/
    let me = { id: null, name: "我" };
    const $landing = document.getElementById("landing");
    const $chat = document.getElementById("chat");
    const $msgs = document.getElementById("msgs");
    const $text = document.getElementById("text");

    /************* 進入點 *************/
    init();

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        document.getElementById("loginBtn").addEventListener("click", loginAndEnter);
        if (liff.isLoggedIn()) await loginAndEnter();
      } catch (e) {
        alert("LIFF 初始化失敗：" + (e?.message || e));
      }
    }

    async function loginAndEnter() {
      if (!liff.isLoggedIn()) return liff.login({ redirectUri: location.href.split("#")[0] });

      const profile = await liff.getProfile();
      me.id = profile.userId;
      me.name = profile.displayName || "我";
      document.getElementById("ctx").textContent = `${me.name}（isInClient: ${liff.isInClient()}）`;

      $landing.style.display = "none";
      $chat.style.display = "block";

      await loadHistory();

      document.getElementById("send").onclick = sendMessage;
      $text.addEventListener("keydown", (e) => { if (e.key === "Enter") sendMessage(); });

      // 輪詢刷新（4 秒一次）。要用 Realtime 再說一聲我幫你接。
      setInterval(loadHistory, 4000);
    }

    /************* 讀取訊息（Edge Function） *************/
    async function loadHistory() {
      try {
        const res = await fetch(READ_URL, {
          headers: {
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, // Verify JWT 開啟時必帶
          },
        });
        const body = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} ${body}`);
        const data = JSON.parse(body);

        // 只在有變化時重繪（簡易）
        $msgs.innerHTML = "";
        for (const m of data) renderMsg(m);
        scrollToBottom();
      } catch (e) {
        console.error(e);
        alert("讀取訊息失敗：" + (e?.message || e));
      }
    }

    /************* 寫入訊息（Edge Function） *************/
    async function sendMessage() {
      const content = ($text.value || "").trim();
      if (!content) return;
      $text.value = "";

      try {
        const res = await fetch(WRITE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          },
          body: JSON.stringify({
            user_id: me.id,
            display_name: me.name,
            content,
          }),
        });
        const body = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} ${body}`);
        const { data } = JSON.parse(body);

        // 先本地插入一條，等下一輪輪詢再完整同步
        renderMsg(data);
        scrollToBottom();

        // （可選）也讓 Bot 推給自己（PUSH_URL 存在才呼叫）
        try {
          if (PUSH_URL) {
            fetch(PUSH_URL, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
              },
              body: JSON.stringify({ userId: me.id, text: content }),
            }).catch(() => {});
          }
        } catch (_) {}
      } catch (e) {
        console.error(e);
        alert("寫入失敗：" + (e?.message || e));
      }
    }

    /************* UI *************/
    function renderMsg(m) {
      const mine = m.user_id === me.id;
      const wrap = document.createElement("div");
      const meta = document.createElement("div");
      const bubble = document.createElement("div");
      wrap.className = "msg " + (mine ? "me" : "other");
      meta.className = "meta";
      const dt = new Date(m.created_at || Date.now());
      meta.textContent = `${m.display_name || "匿名"} • ${dt.toLocaleTimeString()}`;
      bubble.textContent = m.content || "";
      wrap.appendChild(meta); wrap.appendChild(bubble);
      $msgs.appendChild(wrap);
    }
    function scrollToBottom(){ $msgs.scrollTop = $msgs.scrollHeight; }
  </script>
</body>
</html>
