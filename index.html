<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>即時連線聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --line:#06c755 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
    .hero{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;text-align:center}
    .title{font-size:28px;font-weight:800;margin:4px 0 8px}
    .sub{color:#9ca3af;margin:0 0 24px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--line);border:none;color:#fff;font-weight:800;padding:12px 18px;border-radius:12px;cursor:pointer}
    .chat{display:none}
    .chatHeader{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #1f2937;background:#0c1528}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 10px #22c55e}
    .roomTitle{font-weight:800}
    .me{margin-left:auto;color:#9ca3af;font-size:12px}
    .msgs{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#0a1222}
    .msg{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.35;white-space:pre-wrap;word-break:break-word}
    .msg.me{align-self:flex-end;background:#1d4ed8}
    .msg.other{align-self:flex-start;background:#374151}
    .meta{font-size:12px;color:#d1d5db;margin-bottom:4px;opacity:.8}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #1f2937;background:#0c1528}
    .input{flex:1;padding:12px 14px;border:1px solid #334155;border-radius:12px;background:#0a1222;color:#e5e7eb}
    .send{padding:12px 16px;border:none;border-radius:12px;background:#2563eb;color:#fff;font-weight:800}
    .tips{padding:10px 16px;background:#0a1222;color:#9ca3af;border-top:1px solid #1f2937}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 登入畫面 -->
    <div id="landing" class="card hero">
      <div class="title">即將進入即時連線聊天室</div>
      <p class="sub">這是一個多人共用的聊天室。請先以 LINE 登入。</p>
      <button id="loginBtn" class="btn">以 LINE 登入</button>
    </div>

    <!-- 聊天室 -->
    <div id="chat" class="card chat">
      <div class="chatHeader">
        <div class="dot"></div>
        <div class="roomTitle">多人聊天室</div>
        <div id="ctx" class="me"></div>
      </div>
      <div id="msgs" class="msgs"></div>
      <div class="composer">
        <input id="text" class="input" placeholder="輸入訊息，按 Enter 送出" />
        <button id="send" class="send">送出</button>
      </div>
      <div class="tips">訊息存於 <code>public.messages</code>。讀寫走 Edge Functions 以避免 WebView 的 CORS 限制。</div>
    </div>
  </div>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <script>
    /************* 設定（已帶入你的參數） *************/
    const LIFF_ID = "2007964190-lv3NAx5a";
    const SUPABASE_URL = "https://mqnreqlsukmtubvgcfm.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xbnJlcWxzdWttdG51YnZnY2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzYyNzksImV4cCI6MjA3MTI1MjI3OX0.WVnitC3EIzJANy8eEY6LaCGMV8aoNcxwJQGL5_YIZUc";

    // 你的 Edge Functions（slug：db-read / db-write / line-push）
    const READ_URL  = `${SUPABASE_URL}/functions/v1/db-read`;
    const WRITE_URL = `${SUPABASE_URL}/functions/v1/db-write`;
    const PUSH_URL  = `${SUPABASE_URL}/functions/v1/line-push`; // 可選

    // 共用 headers（Edge Functions 常見需求：Authorization + apikey）
    const BASE_HEADERS = {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
      "apikey": SUPABASE_ANON_KEY,
      "Cache-Control": "no-store"
    };

    /************* 狀態 *************/
    let me = { id: null, name: "我" };
    const $landing = document.getElementById("landing");
    const $chat = document.getElementById("chat");
    const $msgs = document.getElementById("msgs");
    const $text = document.getElementById("text");

    let poller = null;
    let loading = false; // 避免重入

    /************* 進入點 *************/
    (async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        document.getElementById("loginBtn").addEventListener("click", loginAndEnter);

        if (liff.isLoggedIn()) {
          await loginAndEnter();
        }
      } catch (e) {
        const msg = e?.message || JSON.stringify(e) || String(e);
        alert("LIFF 初始化失敗：" + msg);
        console.error("[LIFF init error]", e);
      }
    })();

    async function loginAndEnter() {
      try {
        if (!liff.isLoggedIn()) {
          // 登入後回到同一頁（避免 # 或查詢參數造成重導不一致）
          return liff.login({ redirectUri: location.origin + location.pathname });
        }

        const profile = await liff.getProfile();
        me.id = profile.userId;
        me.name = profile.displayName || "我";
        document.getElementById("ctx").textContent =
          `${me.name}（isInClient: ${liff.isInClient()}）`;

        $landing.style.display = "none";
        $chat.style.display = "block";

        await loadHistory(true);

        document.getElementById("send").onclick = sendMessage;
        $text.addEventListener("keydown", (e) => {
          if (e.key === "Enter") sendMessage();
        });

        // 啟動輪詢（4 秒一次），避免重複啟動
        if (!poller) {
          poller = setInterval(() => loadHistory(false), 4000);
        }

        // 背景暫停輪詢、回來再重啟
        document.addEventListener("visibilitychange", () => {
          if (document.hidden) {
            if (poller) { clearInterval(poller); poller = null; }
          } else if (!poller) {
            loadHistory(false);
            poller = setInterval(() => loadHistory(false), 4000);
          }
        });
      } catch (e) {
        const msg = e?.message || JSON.stringify(e) || String(e);
        alert("登入流程錯誤：" + msg);
        console.error("[loginAndEnter error]", e);
      }
    }

    /************* 讀取訊息（Edge Function） *************/
    async function loadHistory(firstLoad = false) {
      if (loading) return;
      loading = true;
      try {
        const res = await fetch(READ_URL, {
          method: "GET",
          headers: BASE_HEADERS,
          cache: "no-store"
        });

        // 允許 204
        if (res.status === 204) {
          if (firstLoad) $msgs.innerHTML = "";
          return;
        }

        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} ${text || ""}`);

        let data;
        try { data = text ? JSON.parse(text) : []; }
        catch { data = []; }

        // 重繪
        $msgs.innerHTML = "";
        if (Array.isArray(data)) {
          for (const m of data) renderMsg(m);
        } else if (data) {
          // 容錯：若回傳單物件
          renderMsg(data);
        }
        scrollToBottom();
      } catch (e) {
        console.error("[loadHistory error]", e);
        // 不用 alert 以免干擾使用
      } finally {
        loading = false;
      }
    }

    /************* 寫入訊息（Edge Function） *************/
    async function sendMessage() {
      const content = ($text.value || "").trim();
      if (!content) return;
      $text.value = "";

      try {
        const res = await fetch(WRITE_URL, {
          method: "POST",
          headers: BASE_HEADERS,
          body: JSON.stringify({
            user_id: me.id,
            display_name: me.name,
            content
          })
        });

        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status} ${text || ""}`);

        let payload;
        try { payload = text ? JSON.parse(text) : null; } catch { payload = null; }

        // 兼容回傳格式：可能是 {data} 或直接物件或陣列
        const rows = Array.isArray(payload) ? payload
                   : payload?.data ? (Array.isArray(payload.data) ? payload.data : [payload.data])
                   : payload ? [payload] : [];

        for (const row of rows) renderMsg(row);
        scrollToBottom();

        // （可選）推播給自己（如果你有做 line-push）
        if (PUSH_URL) {
          fetch(PUSH_URL, {
            method: "POST",
            headers: BASE_HEADERS,
            body: JSON.stringify({ userId: me.id, text: content })
          }).catch(() => {});
        }
      } catch (e) {
        console.error("[sendMessage error]", e);
        alert("寫入失敗：" + (e?.message || e));
      }
    }

    /************* UI *************/
    function renderMsg(m) {
      const mine = m.user_id === me.id;
      const wrap = document.createElement("div");
      const meta = document.createElement("div");
      const bubble = document.createElement("div");

      wrap.className = "msg " + (mine ? "me" : "other");
      meta.className = "meta";

      const dt = new Date(m.created_at || Date.now());
      const who = m.display_name || "匿名";
      meta.textContent = `${who} • ${dt.toLocaleTimeString()}`;

      bubble.textContent = m.content || "";

      wrap.appendChild(meta);
      wrap.appendChild(bubble);
      $msgs.appendChild(wrap);
    }

    function scrollToBottom(){ $msgs.scrollTop = $msgs.scrollHeight; }
  </script>
</body>
</html>