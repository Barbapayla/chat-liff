<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>即時連線聊天室</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#9ca3af; --line:#06c755 }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#0b1220;color:#e5e7eb}
    .wrap{max-width:820px;margin:0 auto;padding:24px}
    .card{background:#0f172a;border:1px solid #1f2937;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.25);overflow:hidden}
    .hero{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:48px 24px;text-align:center}
    .title{font-size:28px;font-weight:800;margin:4px 0 8px}
    .sub{color:#9ca3af;margin:0 0 24px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:var(--line);border:none;color:#fff;font-weight:800;padding:12px 18px;border-radius:12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .chat{display:none}
    .chatHeader{display:flex;align-items:center;gap:10px;padding:16px;border-bottom:1px solid #1f2937;background:#0c1528}
    .dot{width:10px;height:10px;border-radius:50%;background:#22c55e;box-shadow:0 0 10px #22c55e}
    .roomTitle{font-weight:800}
    .me{margin-left:auto;color:#9ca3af;font-size:12px}
    .msgs{height:60vh;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:12px;background:#0a1222}
    .msg{max-width:70%;padding:10px 12px;border-radius:14px;line-height:1.35;white-space:pre-wrap;word-break:break-word}
    .msg.me{align-self:flex-end;background:#1d4ed8}
    .msg.other{align-self:flex-start;background:#374151}
    .meta{font-size:12px;color:#d1d5db;margin-bottom:4px;opacity:.8}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid #1f2937;background:#0c1528}
    .input{flex:1;padding:12px 14px;border:1px solid #334155;border-radius:12px;background:#0a1222;color:#e5e7eb}
    .send{padding:12px 16px;border:none;border-radius:12px;background:#2563eb;color:#fff;font-weight:800}
    .tips{padding:10px 16px;background:#0a1222;color:#9ca3af;border-top:1px solid #1f2937}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- 登入畫面 -->
    <div id="landing" class="card hero">
      <div class="title">即將進入即時連線聊天室</div>
      <p class="sub">這是一個多人共用的聊天室。請先以 LINE 登入。</p>
      <button id="loginBtn" class="btn">以 LINE 登入</button>
    </div>

    <!-- 聊天室 -->
    <div id="chat" class="card chat">
      <div class="chatHeader">
        <div class="dot"></div>
        <div class="roomTitle">多人聊天室</div>
        <div id="ctx" class="me"></div>
      </div>
      <div id="msgs" class="msgs"></div>
      <div class="composer">
        <input id="text" class="input" placeholder="輸入訊息，按 Enter 送出" />
        <button id="send" class="send">送出</button>
      </div>
      <div class="tips">此聊天室所有人都能看到彼此訊息（資料表：<code>public.messages</code>）。</div>
    </div>
  </div>

  <!-- SDKs -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2.39.3/dist/umd/supabase.js"></script>

  <script>
    /*** 你的設定 ***/
    const LIFF_ID = "2007964190-lv3NAx5a";
    const SUPABASE_URL = "https://mqnreqlsukmtubvgcfm.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xbnJlcWxzdWttdG51YnZnY2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzYyNzksImV4cCI6MjA3MTI1MjI3OX0.WVnitC3EIzJANy8eEY6LaCGMV8aoNcxwJQGL5_YIZUc";

    const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /*** 狀態 ***/
    let me = { id: null, name: "我" };
    const $landing = document.getElementById("landing");
    const $chat = document.getElementById("chat");
    const $msgs = document.getElementById("msgs");
    const $text = document.getElementById("text");

    /*** 進入點 ***/
    init();

    async function init() {
      try {
        await liff.init({ liffId: LIFF_ID });
        document.getElementById("loginBtn").addEventListener("click", loginAndEnter);
        if (liff.isLoggedIn()) await loginAndEnter();
      } catch (e) {
        alert("LIFF 初始化失敗：" + (e?.message || e));
      }
    }

    async function loginAndEnter() {
      if (!liff.isLoggedIn()) return liff.login({ redirectUri: location.href.split("#")[0] });

      const profile = await liff.getProfile();
      me.id = profile.userId;
      me.name = profile.displayName || "我";

      document.getElementById("ctx").textContent =
        `${me.name}（isInClient: ${liff.isInClient()}）`;

      $landing.style.display = "none";
      $chat.style.display = "block";

      await loadHistory();
      subscribeRealtime();

      document.getElementById("send").onclick = insertMessage; // 綁定強化版 insert
      $text.addEventListener("keydown", (e) => { if (e.key === "Enter") insertMessage(); });
      $text.focus();
    }

    /*** 健檢：確認 Supabase 可連線（避免只看到 Failed to fetch） ***/
    async function pingSupabase() {
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/`, {
          method: "GET",
          headers: {
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
          },
        });
        console.log("[pingSupabase]", res.status, res.statusText);
        return res.ok;
      } catch (e) {
        console.error("[pingSupabase] network error:", e);
        return false;
      }
    }

    /*** 強化版：寫入 messages（直接呼叫 REST，錯誤詳列） ***/
    async function insertMessage() {
      const ok = await pingSupabase();
      if (!ok) {
        alert("❌ 無法連到 Supabase（可能是 CORS/網路被擋）。請改用手機 LINE 開啟或稍後再試。");
        return;
      }
      try {
        const content = ($text.value || "").trim();
        if (!content) return;
        $text.value = "";

        const res = await fetch(`${SUPABASE_URL}/rest/v1/messages`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_ANON_KEY,
            Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
            Prefer: "return=representation",
          },
          body: JSON.stringify([{
            user_id: me.id,
            display_name: me.name,
            content,
          }]),
        });

        const text = await res.text();
        if (!res.ok) {
          console.error("[insert REST] status:", res.status, text);
          alert(`❌ 寫入失敗：HTTP ${res.status}\n${text || "No body"}`);
          return;
        }

        console.log("[insert REST] ok:", text);
        // 由 Realtime 訂閱自動渲染，不用自己加
      } catch (err) {
        console.error(err);
        alert("❌ 寫入失敗：" + (err?.message || err));
      }
    }

    /*** 歷史訊息 ***/
    async function loadHistory() {
      const { data, error } = await db
        .from("messages")
        .select("*")
        .order("created_at", { ascending: true })
        .limit(50);
      if (error) return alert("讀取訊息失敗：" + error.message);
      $msgs.innerHTML = "";
      for (const m of data || []) renderMsg(m);
      scrollToBottom();
    }

    /*** 即時 ***/
    function subscribeRealtime() {
      db.channel("public:messages")
        .on("postgres_changes", { event: "INSERT", schema: "public", table: "messages" }, (payload) => {
          renderMsg(payload.new);
          scrollToBottom();
        })
        .subscribe();
    }

    /*** UI ***/
    function renderMsg(m) {
      const mine = m.user_id === me.id;
      const wrap = document.createElement("div");
      const meta = document.createElement("div");
      const bubble = document.createElement("div");
      wrap.className = "msg " + (mine ? "me" : "other");
      meta.className = "meta";
      const dt = new Date(m.created_at || Date.now());
      meta.textContent = `${m.display_name || "匿名"} • ${dt.toLocaleTimeString()}`;
      bubble.textContent = m.content || "";
      wrap.appendChild(meta); wrap.appendChild(bubble);
      $msgs.appendChild(wrap);
    }
    function scrollToBottom(){ $msgs.scrollTop = $msgs.scrollHeight; }
  </script>
</body>
</html>
