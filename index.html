<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>LINE 推送測試</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h2>LINE 推送訊息測試</h2>
  <input type="text" id="msgText" placeholder="輸入要推送的訊息" />
  <button onclick="pushMessage()">發送訊息</button>

  <script>
    const LIFF_ID = "2007964190-lv3NAx5a"; // 記得換成你在 LINE Developers 建立的 LIFF ID
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1xbnJlcWxzdWttdG51YnZnY2ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2NzYyNzksImV4cCI6MjA3MTI1MjI3OX0.WVnitC3EIzJANy8eEY6LaCGMV8aoNcxwJQGL5_YIZUc";
    const EDGE_PUSH_URL = "https://mqnreqlsukmtnubvgcfm.supabase.co/functions/v1/smooth-function";

    async function main() {
      await liff.init({ liffId: LIFF_ID });
      if (!liff.isLoggedIn()) {
        liff.login({ redirectUri: window.location.href });
      }
    }

    async function pushMessage() {
      try {
        if (!liff.isLoggedIn()) {
          await liff.login({ redirectUri: location.href.split("#")[0] });
        }
        const profile = await liff.getProfile();
        const userId = profile.userId;
        const text = (document.getElementById("msgText").value || "").trim();
        if (!text) return alert("請輸入訊息");

        const res = await fetch(EDGE_PUSH_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, // ★ 必須帶
          },
          body: JSON.stringify({ userId, text }),
        });

        if (!res.ok) {
          const body = await res.text();
          alert("❌ 推送失敗：" + body);
          return;
        }
        alert("✅ 已請 Bot 推送訊息到你的 LINE！");
      } catch (err) {
        console.error(err);
        alert("❌ 發送流程失敗：" + (err?.message || err));
      }
    }

    main();
  </script>
</body>
</html>
